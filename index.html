<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bold Bean Co - Stockist Map</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans"
      rel="stylesheet"
    />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
    <script>
      var exports = {}; // quick fix because 'exports' is not defined in rich-text bundle below
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@contentful/rich-text-html-renderer@14.1.2/dist/rich-text-html-renderer.es5.min.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .marker {
        background-image: url("./img/mapbox-icon.png");
        background-size: cover;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
      }

      .mapboxgl-popup {
        max-width: 200px;
      }

      .mapboxgl-popup-content {
        text-align: left;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoiZGlnYnlrIiwiYSI6ImNra2ZjMmxxMjBzMGgyb21uZHltb2wwYjIifQ.tfI899NGWW__KVmKVl8qBg";
      if (window.navigator.geolocation) {
        window.navigator.geolocation.getCurrentPosition(
          function (position) {
            drawMap(position.coords.longitude, position.coords.latitude);
          },
          function () {
            drawMap(-0.9859655, 51.5845089);
          }
        );
      } else {
        drawMap(-0.9859655, 51.5845089);
      }
      function drawMap(lat, lng) {
        var map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/mapbox/outdoors-v11",
          center: [lat, lng],
          zoom: 10,
        });
        var client = contentful.createClient({
          space: "6v34qe172vks",
          accessToken: "vYDWMMLQ75F3agfli-nyOp29eah00JIvj_qqMwaKDbk",
        });
        console.log(documentToHtmlString);
        client.getEntries().then(function (entries) {
          entries.items.forEach(function (entry) {
            var el = document.createElement("div");
            el.className = "marker";
            new mapboxgl.Marker({
              anchor: "bottom",
            })
              .setLngLat([entry.fields.location.lon, entry.fields.location.lat])
              .setPopup(
                new mapboxgl.Popup({ offset: 25 }) // add popups
                  .setHTML(
                    `<h3>${entry.fields.name}</h3><div>${documentToHtmlString(
                      entry.fields.description
                    )}</div><p><a href="${entry.fields.url}">${
                      entry.fields.url ? entry.fields.url : ""
                    }</a></p><p><a href="email:${entry.fields.email}">${
                      entry.fields.email ? entry.fields.email : ""
                    }</a></p>`
                  )
              )
              .addTo(map);
          });
        });
      }
    </script>
  </body>
</html>
